import "./styles/dashboardpage.css";
import BarChart from "../../components/BarChart";
import EmployeeTable from "../../components/EmployeeTable";
import { useGetDashboardDataQuery } from "../../redux/slices/API/lead.apiSlice";
import { useGetActivityAdminQuery } from "../../redux/slices/API/activity.apiSlice";
import { useGetEmployeeMutation } from "../../redux/slices/API/employee.apiSlice";

function DashboardPage() {
  const { data: dashboardData } = useGetDashboardDataQuery();
  const { data: activityAdminData } = useGetActivityAdminQuery();
  const [getEmployee] = useGetEmployeeMutation();

  const getEmployeeData = (employeeId)=>{
    getEmployee(employeeId).unwrap()
      .then((data) => {
        return data;
      })
      .catch((error) => {
        console.error("Error fetching employee data:", error);
      });
  }

  const getTimeAgo = (createdAt) => {
    const created = new Date(createdAt);
    const now = new Date();
    const diffMs = now - created;
    const diffHrs = diffMs / (1000 * 60 * 60);
    if (diffHrs < 1) return "recently";
    const rounded = Math.floor(diffHrs);
    const mins = (diffHrs - rounded) * 60;
    if (mins >= 30) return `${rounded + 1} hour ago`;
    return `${rounded} hour ago`;
  };

  const getActivityMessage = (activity) => {
    const employeeId = activity.employeeId;
    const employeeData = getEmployeeData(employeeId);
    const employeeName = employeeData ? `${employeeData.firstName}` : "Unknown Employee";
    let timeAgo = getTimeAgo(activity.createdAt);

    if (activity.activityType === "lead assigned") {
      return `You assigned a lead to ${employeeName} - ${timeAgo}`;
    } else if (activity.activityType === "lead closed") {
      return `${employeeName} closed a lead - ${timeAgo}`;
    } else if (activity.activityType === "lead added") {
      return `You added a lead - ${timeAgo}`;
    }
    return "";
  };

  return (
    <div className="dashboard-page-container">
      <section className="analytics-section">
        <div className="analytics-card">
          <svg
            width="32"
            height="33"
            viewBox="0 0 32 33"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <circle cx="16" cy="16.5" r="16" fill="#ECECEC" />
            <path
              d="M17.8334 17.4167C17.0695 17.4167 16.4202 17.1494 15.8855 16.6147C15.3508 16.0799 15.0834 15.4306 15.0834 14.6667C15.0834 13.9029 15.3508 13.2536 15.8855 12.7188C16.4202 12.1841 17.0695 11.9167 17.8334 11.9167C18.5973 11.9167 19.2466 12.1841 19.7813 12.7188C20.3161 13.2536 20.5834 13.9029 20.5834 14.6667C20.5834 15.4306 20.3161 16.0799 19.7813 16.6147C19.2466 17.1494 18.5973 17.4167 17.8334 17.4167ZM11.4167 20.1667C10.9126 20.1667 10.481 19.9872 10.122 19.6282C9.76293 19.2692 9.58341 18.8376 9.58341 18.3334V11.0001C9.58341 10.4959 9.76293 10.0643 10.122 9.70529C10.481 9.34626 10.9126 9.16675 11.4167 9.16675H24.2501C24.7542 9.16675 25.1858 9.34626 25.5449 9.70529C25.9039 10.0643 26.0834 10.4959 26.0834 11.0001V18.3334C26.0834 18.8376 25.9039 19.2692 25.5449 19.6282C25.1858 19.9872 24.7542 20.1667 24.2501 20.1667H11.4167ZM13.2501 18.3334H22.4167C22.4167 17.8292 22.5963 17.3977 22.9553 17.0386C23.3143 16.6796 23.7459 16.5001 24.2501 16.5001V12.8334C23.7459 12.8334 23.3143 12.6539 22.9553 12.2949C22.5963 11.9358 22.4167 11.5042 22.4167 11.0001H13.2501C13.2501 11.5042 13.0706 11.9358 12.7115 12.2949C12.3525 12.6539 11.9209 12.8334 11.4167 12.8334V16.5001C11.9209 16.5001 12.3525 16.6796 12.7115 17.0386C13.0706 17.3977 13.2501 17.8292 13.2501 18.3334ZM23.3334 23.8334H7.75008C7.24591 23.8334 6.81432 23.6539 6.45529 23.2949C6.09626 22.9358 5.91675 22.5042 5.91675 22.0001V11.9167H7.75008V22.0001H23.3334V23.8334Z"
              fill="#616161"
            />
          </svg>
          <div>
            <p>Unassigned Leads</p>
            <span>{dashboardData?.unassignedLeadsCount}</span>
          </div>
        </div>
        <div className="analytics-card">
          <svg
            width="32"
            height="32"
            viewBox="0 0 32 32"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <circle cx="16" cy="16" r="16" fill="#ECECEC" />
            <path
              d="M15.9998 16.0001C14.9915 16.0001 14.1283 15.6411 13.4103 14.923C12.6922 14.2049 12.3332 13.3417 12.3332 12.3334C12.3332 11.3251 12.6922 10.4619 13.4103 9.74383C14.1283 9.02578 14.9915 8.66675 15.9998 8.66675C17.0082 8.66675 17.8714 9.02578 18.5894 9.74383C19.3075 10.4619 19.6665 11.3251 19.6665 12.3334C19.6665 13.3417 19.3075 14.2049 18.5894 14.923C17.8714 15.6411 17.0082 16.0001 15.9998 16.0001ZM8.6665 23.3334V20.7667C8.6665 20.2473 8.80018 19.7699 9.06755 19.3345C9.33491 18.899 9.69011 18.5667 10.1332 18.3376C11.0804 17.864 12.0429 17.5088 13.0207 17.272C13.9984 17.0352 14.9915 16.9167 15.9998 16.9167C17.0082 16.9167 18.0012 17.0352 18.979 17.272C19.9568 17.5088 20.9193 17.864 21.8665 18.3376C22.3096 18.5667 22.6648 18.899 22.9321 19.3345C23.1995 19.7699 23.3332 20.2473 23.3332 20.7667V23.3334H8.6665ZM10.4998 21.5001H21.4998V20.7667C21.4998 20.5987 21.4578 20.4459 21.3738 20.3084C21.2898 20.1709 21.179 20.064 21.0415 19.9876C20.2165 19.5751 19.3839 19.2657 18.5436 19.0595C17.7033 18.8532 16.8554 18.7501 15.9998 18.7501C15.1443 18.7501 14.2964 18.8532 13.4561 19.0595C12.6158 19.2657 11.7832 19.5751 10.9582 19.9876C10.8207 20.064 10.7099 20.1709 10.6259 20.3084C10.5419 20.4459 10.4998 20.5987 10.4998 20.7667V21.5001ZM15.9998 14.1667C16.504 14.1667 16.9356 13.9872 17.2946 13.6282C17.6537 13.2692 17.8332 12.8376 17.8332 12.3334C17.8332 11.8292 17.6537 11.3977 17.2946 11.0386C16.9356 10.6796 16.504 10.5001 15.9998 10.5001C15.4957 10.5001 15.0641 10.6796 14.705 11.0386C14.346 11.3977 14.1665 11.8292 14.1665 12.3334C14.1665 12.8376 14.346 13.2692 14.705 13.6282C15.0641 13.9872 15.4957 14.1667 15.9998 14.1667Z"
              fill="#616161"
            />
          </svg>
          <div>
            <p>Assigned This Week</p>
            <span>{dashboardData?.assignedLeadsThisWeekCount}</span>
          </div>
        </div>
        <div className="analytics-card">
          <svg
            width="32"
            height="32"
            viewBox="0 0 32 32"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <circle cx="16" cy="16" r="16" fill="#ECECEC" />
            <path
              d="M15.8856 23.3333C15.9467 23.3333 16.0079 23.318 16.069 23.2874C16.1301 23.2569 16.1759 23.2263 16.2065 23.1958L23.7231 15.6791C23.9065 15.4958 24.0401 15.2895 24.1242 15.0603C24.2082 14.8312 24.2502 14.602 24.2502 14.3728C24.2502 14.1284 24.2082 13.8954 24.1242 13.6739C24.0401 13.4523 23.9065 13.2576 23.7231 13.0895L19.8273 9.19367C19.6592 9.01034 19.4645 8.87665 19.2429 8.79263C19.0214 8.7086 18.7884 8.66659 18.544 8.66659C18.3148 8.66659 18.0856 8.7086 17.8565 8.79263C17.6273 8.87665 17.421 9.01034 17.2377 9.19367L16.9856 9.44575L18.6815 11.1645C18.9106 11.3784 19.0787 11.6228 19.1856 11.8978C19.2926 12.1728 19.346 12.4631 19.346 12.7687C19.346 13.4103 19.1283 13.9489 18.6929 14.3843C18.2575 14.8197 17.719 15.0374 17.0773 15.0374C16.7717 15.0374 16.4776 14.9839 16.195 14.877C15.9124 14.7701 15.6641 14.6096 15.4502 14.3958L13.7315 12.6999L9.72105 16.7103C9.67521 16.7562 9.64084 16.8058 9.61792 16.8593C9.59501 16.9128 9.58355 16.9701 9.58355 17.0312C9.58355 17.1534 9.62938 17.2642 9.72105 17.3635C9.81271 17.4628 9.91966 17.5124 10.0419 17.5124C10.103 17.5124 10.1641 17.4971 10.2252 17.4666C10.2863 17.436 10.3322 17.4055 10.3627 17.3749L13.4794 14.2583L14.7627 15.5416L11.669 18.6583C11.6231 18.7041 11.5888 18.7537 11.5658 18.8072C11.5429 18.8607 11.5315 18.918 11.5315 18.9791C11.5315 19.1013 11.5773 19.2083 11.669 19.2999C11.7606 19.3916 11.8676 19.4374 11.9898 19.4374C12.0509 19.4374 12.112 19.4221 12.1731 19.3916C12.2342 19.361 12.2801 19.3305 12.3106 19.2999L15.4273 16.2062L16.7106 17.4895L13.6169 20.6062C13.571 20.6367 13.5367 20.6826 13.5138 20.7437C13.4908 20.8048 13.4794 20.8659 13.4794 20.927C13.4794 21.0492 13.5252 21.1562 13.6169 21.2478C13.7085 21.3395 13.8155 21.3853 13.9377 21.3853C13.9988 21.3853 14.0561 21.3739 14.1096 21.351C14.1631 21.328 14.2127 21.2937 14.2585 21.2478L17.3752 18.1541L18.6585 19.4374L15.5419 22.5541C15.496 22.5999 15.4617 22.6496 15.4388 22.703C15.4158 22.7565 15.4044 22.8138 15.4044 22.8749C15.4044 22.9971 15.454 23.1041 15.5533 23.1958C15.6526 23.2874 15.7634 23.3333 15.8856 23.3333ZM15.8627 25.1666C15.2974 25.1666 14.7971 24.9794 14.3617 24.6051C13.9263 24.2308 13.6704 23.761 13.594 23.1958C13.0745 23.1194 12.6391 22.9055 12.2877 22.5541C11.9363 22.2027 11.7224 21.7673 11.646 21.2478C11.1266 21.1714 10.695 20.9537 10.3513 20.5947C10.0075 20.2357 9.79744 19.8041 9.72105 19.2999C9.14049 19.2235 8.66688 18.9714 8.30021 18.5437C7.93355 18.1159 7.75021 17.6117 7.75021 17.0312C7.75021 16.7256 7.80751 16.4315 7.92209 16.1489C8.03667 15.8662 8.20091 15.618 8.4148 15.4041L13.7315 10.1103L16.7335 13.1124C16.7641 13.1583 16.8099 13.1926 16.871 13.2155C16.9322 13.2385 16.9933 13.2499 17.0544 13.2499C17.1919 13.2499 17.3065 13.2079 17.3981 13.1239C17.4898 13.0398 17.5356 12.9291 17.5356 12.7916C17.5356 12.7305 17.5242 12.6694 17.5013 12.6083C17.4783 12.5471 17.444 12.5013 17.3981 12.4708L14.121 9.19367C13.953 9.01034 13.7582 8.87665 13.5367 8.79263C13.3151 8.7086 13.0822 8.66659 12.8377 8.66659C12.6085 8.66659 12.3794 8.7086 12.1502 8.79263C11.921 8.87665 11.7148 9.01034 11.5315 9.19367L8.30021 12.4478C8.16271 12.5853 8.04813 12.7458 7.95646 12.9291C7.8648 13.1124 7.80369 13.2958 7.77313 13.4791C7.74258 13.6624 7.74258 13.8496 7.77313 14.0405C7.80369 14.2315 7.8648 14.411 7.95646 14.5791L6.6273 15.9083C6.36758 15.5569 6.1766 15.1711 6.05438 14.751C5.93216 14.3308 5.88633 13.9069 5.91688 13.4791C5.94744 13.0513 6.05438 12.635 6.23771 12.2301C6.42105 11.8253 6.67313 11.4624 6.99396 11.1416L10.2252 7.91034C10.5919 7.55895 11.0006 7.29159 11.4513 7.10825C11.902 6.92492 12.3641 6.83325 12.8377 6.83325C13.3113 6.83325 13.7735 6.92492 14.2242 7.10825C14.6749 7.29159 15.0759 7.55895 15.4273 7.91034L15.6794 8.16242L15.9315 7.91034C16.2981 7.55895 16.7068 7.29159 17.1575 7.10825C17.6082 6.92492 18.0704 6.83325 18.544 6.83325C19.0176 6.83325 19.4797 6.92492 19.9304 7.10825C20.3811 7.29159 20.7822 7.55895 21.1335 7.91034L25.0065 11.7833C25.3579 12.1346 25.6252 12.5395 25.8085 12.9978C25.9919 13.4562 26.0835 13.9221 26.0835 14.3958C26.0835 14.8694 25.9919 15.3315 25.8085 15.7822C25.6252 16.2329 25.3579 16.6339 25.0065 16.9853L17.4898 24.4791C17.2759 24.693 17.0276 24.861 16.745 24.9833C16.4624 25.1055 16.1683 25.1666 15.8627 25.1666Z"
              fill="#616161"
            />
          </svg>
          <div>
            <p>Active Salespeople</p>
            <span>{dashboardData?.activeSalesEmployees}</span>
          </div>
        </div>
        <div className="analytics-card">
          <svg
            width="32"
            height="32"
            viewBox="0 0 32 32"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <circle cx="16" cy="16" r="16" fill="#ECECEC" />
            <path
              d="M11.7606 24.2729C11.2106 24.2576 10.6873 24.1163 10.1908 23.849C9.69426 23.5816 9.22447 23.1882 8.78141 22.6688C8.1703 21.9354 7.69287 21.0608 7.34912 20.0448C7.00537 19.0288 6.8335 17.9861 6.8335 16.9167C6.8335 15.6486 7.07412 14.4569 7.55537 13.3417C8.03662 12.2264 8.68975 11.2563 9.51475 10.4313C10.3397 9.60625 11.3099 8.95312 12.4252 8.47188C13.5404 7.99063 14.7321 7.75 16.0002 7.75C17.2682 7.75 18.4599 7.99444 19.5752 8.48333C20.6904 8.97222 21.6606 9.63681 22.4856 10.4771C23.3106 11.3174 23.9637 12.3028 24.445 13.4333C24.9262 14.5639 25.1668 15.7785 25.1668 17.0771C25.1668 18.2535 24.9759 19.3535 24.5939 20.3771C24.212 21.4007 23.6696 22.2639 22.9668 22.9667C22.5391 23.3944 22.0884 23.7191 21.6147 23.9406C21.1411 24.1622 20.6599 24.2729 20.171 24.2729C19.896 24.2729 19.621 24.2385 19.346 24.1698C19.071 24.101 18.796 23.9979 18.521 23.8604L17.2377 23.2188C17.0543 23.1271 16.8595 23.0583 16.6533 23.0125C16.447 22.9667 16.2293 22.9438 16.0002 22.9438C15.771 22.9438 15.5533 22.9667 15.347 23.0125C15.1408 23.0583 14.946 23.1271 14.7627 23.2188L13.4793 23.8604C13.1891 24.0132 12.9026 24.124 12.62 24.1927C12.3373 24.2615 12.0509 24.2882 11.7606 24.2729ZM11.8064 22.4396C11.9439 22.4396 12.0852 22.4243 12.2304 22.3938C12.3755 22.3632 12.5168 22.3097 12.6543 22.2333L13.9377 21.5917C14.2585 21.4236 14.5908 21.3014 14.9345 21.225C15.2783 21.1486 15.6259 21.1104 15.9772 21.1104C16.3286 21.1104 16.68 21.1486 17.0314 21.225C17.3828 21.3014 17.7189 21.4236 18.0397 21.5917L19.346 22.2333C19.4835 22.3097 19.621 22.3632 19.7585 22.3938C19.896 22.4243 20.0335 22.4396 20.171 22.4396C20.4613 22.4396 20.7363 22.3632 20.996 22.2104C21.2557 22.0576 21.5154 21.8285 21.7752 21.5229C22.2641 20.9424 22.646 20.2472 22.921 19.4375C23.196 18.6278 23.3335 17.7951 23.3335 16.9396C23.3335 14.8924 22.6231 13.1545 21.2022 11.726C19.7814 10.2976 18.0474 9.58333 16.0002 9.58333C13.9529 9.58333 12.2189 10.3014 10.7981 11.7375C9.37725 13.1736 8.66683 14.9153 8.66683 16.9625C8.66683 17.8333 8.80815 18.6813 9.09079 19.5063C9.37343 20.3313 9.76683 21.0264 10.271 21.5917C10.5307 21.8972 10.7828 22.1149 11.0272 22.2448C11.2717 22.3747 11.5314 22.4396 11.8064 22.4396ZM16.0002 18.75C16.5043 18.75 16.9359 18.5705 17.295 18.2115C17.654 17.8524 17.8335 17.4208 17.8335 16.9167C17.8335 16.7944 17.822 16.6722 17.7991 16.55C17.7762 16.4278 17.7418 16.3056 17.696 16.1833L18.8418 14.6479C18.9946 14.8465 19.1283 15.0566 19.2429 15.2781C19.3575 15.4997 19.4529 15.7403 19.5293 16H21.4085C21.1793 14.6556 20.5568 13.5556 19.5408 12.7C18.5248 11.8444 17.3446 11.4167 16.0002 11.4167C14.6557 11.4167 13.4717 11.8483 12.4481 12.7115C11.4245 13.5747 10.8057 14.6708 10.5918 16H12.471C12.6849 15.175 13.1203 14.5104 13.7772 14.0062C14.4342 13.5021 15.1752 13.25 16.0002 13.25C16.2599 13.25 16.5043 13.2729 16.7335 13.3187C16.9627 13.3646 17.1842 13.4333 17.3981 13.525L16.2293 15.1063C16.1988 15.1063 16.1606 15.1024 16.1147 15.0948C16.0689 15.0872 16.0307 15.0833 16.0002 15.0833C15.496 15.0833 15.0644 15.2628 14.7054 15.6219C14.3463 15.9809 14.1668 16.4125 14.1668 16.9167C14.1668 17.4208 14.3463 17.8524 14.7054 18.2115C15.0644 18.5705 15.496 18.75 16.0002 18.75Z"
              fill="#616161"
            />
          </svg>
          <div>
            <p>Conversion Rate</p>
            <span>{dashboardData?.conversionRate}%</span>
          </div>
        </div>
      </section>

      <section className="sales-section">
        <div className="sales-activity-bar-graph">
          <BarChart />
        </div>
        <div className="activity-card">
          <h4>Recent Activity Feed</h4>
          <ul>
            {activityAdminData?.map((activity, index) => {
              return (
              <li key={index}>{getActivityMessage(activity)}</li>
            )})}
          </ul>
        </div>
      </section>

      <section className="employee-section">
        <EmployeeTable />
      </section>
    </div>
  );
}

export default DashboardPage;
